 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QR Send - Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        :root {
            --primary: #075e54; --secondary: #128c7e; --light: #dcf8c6; --dark: #1f2c34;
            --bg: #e5ddd5; --white: #ffffff; --red: #d32f2f; --green: #25d366;
        }
        body { background: var(--bg); height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        
        /* Dark Mode toggle logic removed to keep code clean, default works best */
        
        .app-container {
            width: 100%; max-width: 1000px; height: 100%; background: var(--white); 
            display: flex; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative;
        }

        /* SIDEBAR (Connection & Files) */
        .sidebar {
            width: 350px; border-right: 1px solid #ddd; display: flex; flex-direction: column; background: #f0f2f5;
        }
        .header {
            padding: 15px; background: var(--primary); color: white; display: flex; 
            justify-content: space-between; align-items: center;
        }
        .header h2 { font-size: 18px; }
        .status-badge { font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; }

        .connect-panel { padding: 20px; text-align: center; flex-grow: 1; overflow-y: auto; }
        #qrcode { background: white; padding: 10px; display: inline-block; border-radius: 8px; margin-bottom: 15px; }
        #qrcode img { display: block; }
        
        .btn {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; 
            font-weight: bold; display: inline-flex; align-items: center; gap: 8px; margin: 5px;
            transition: 0.2s;
        }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-outline { border: 1px solid var(--secondary); color: var(--secondary); background: transparent; }
        .btn:active { transform: scale(0.98); }

        /* FILE TRANSFER SECTION */
        .files-panel {
            padding: 15px; background: white; border-top: 1px solid #ddd; 
            display: flex; flex-direction: column; max-height: 40%; /* Limit height */
        }
        .files-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        #file-input { display: none; }
        
        /* SCROLLABLE LIST FOR FILES */
        #transfer-list {
            flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
            padding-right: 5px; min-height: 0; /* Crucial for scrolling */
        }
        /* Scrollbar styling */
        #transfer-list::-webkit-scrollbar { width: 5px; }
        #transfer-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        .transfer-item {
            background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee;
            position: relative; font-size: 13px;
        }
        .t-info { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .t-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
        .t-bar-bg { height: 6px; background: #ddd; border-radius: 3px; overflow: hidden; }
        .t-bar-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.2s; }
        .t-meta { display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 4px; }
        .btn-cancel {
            background: transparent; color: var(--red); border: none; font-size: 16px; 
            font-weight: bold; cursor: pointer; line-height: 1;
        }

        /* CHAT SECTION */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: #e5ddd5; position: relative; }
        
        .chat-header {
            padding: 10px 15px; background: #f0f2f5; border-bottom: 1px solid #ddd; 
            display: flex; justify-content: space-between; align-items: center; height: 60px;
        }
        .chat-user { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 40px; height: 40px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .chat-actions { display: flex; gap: 15px; }
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--primary); font-size: 20px; padding: 5px; }
        .icon-btn:hover { background: rgba(0,0,0,0.05); border-radius: 50%; }

        .messages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.sent { align-self: flex-end; background: var(--light); border-top-right-radius: 0; }
        .msg.received { align-self: flex-start; background: white; border-top-left-radius: 0; }
        .msg-time { font-size: 10px; color: #999; float: right; margin-top: 5px; margin-left: 10px; display: flex; align-items: center; gap: 3px; }
        .double-tick { color: #4fc3f7; font-weight: bold; font-size: 10px; }
        
        .msg img { max-width: 250px; border-radius: 6px; cursor: pointer; }
        
        /* Reply Context */
        .reply-bar { 
            background: rgba(255,255,255,0.9); padding: 5px 15px; border-left: 5px solid var(--secondary); 
            display: none; justify-content: space-between; font-size: 12px; color: #555;
        }
        .msg-reply-preview { background: rgba(0,0,0,0.05); padding: 4px; border-left: 3px solid var(--secondary); margin-bottom: 4px; border-radius: 4px; font-size: 11px; }
        .reply-btn { position: absolute; top: 5px; right: -25px; background: white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 12px; }
        .msg:hover .reply-btn { display: flex; }

        .input-area { padding: 10px; background: #f0f2f5; display: flex; align-items: center; gap: 10px; }
        #msg-input { flex-grow: 1; padding: 12px; border: none; border-radius: 20px; outline: none; font-size: 15px; }
        .send-btn { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* CALL OVERLAYS */
        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            align-items: center; justify-content: center; color: white;
        }
        /* Incoming Call */
        .call-card { background: #1f2c34; padding: 40px; border-radius: 20px; text-align: center; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .call-avatar-lg { width: 100px; height: 100px; background: #ddd; border-radius: 50%; margin: 0 auto 20px; overflow: hidden; }
        .call-actions { display: flex; justify-content: space-around; margin-top: 40px; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .btn-accept { background: var(--green); color: white; animation: pulse 1.5s infinite; }
        .btn-reject { background: var(--red); color: white; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(37, 211, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); } }

        /* Active Call */
        .active-call-ui { width: 100%; height: 100%; position: relative; display: flex; flex-direction: column; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; bottom: 100px; right: 20px; width: 120px; height: 160px; background: #333; border-radius: 10px; border: 2px solid white; object-fit: cover; }
        .call-controls-bar { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); padding: 15px 30px; border-radius: 30px;
            display: flex; gap: 20px;
        }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .control-btn.off { background: white; color: black; }
        .btn-hangup { background: var(--red); }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        .modal-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; }
        .modal-dl { position: absolute; bottom: 30px; background: white; color: black; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-weight: bold; }

        /* Scanner Overlay */
        #scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 4000; display: none; flex-direction: column; }
        #qr-reader { flex-grow: 1; }
        .scanner-close { position: absolute; top: 20px; right: 20px; color: white; z-index: 4001; font-size: 30px; cursor: pointer; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-shrink: 0; border-right: none; border-bottom: 1px solid #ddd; }
            .connect-panel { display: none; } /* Hide connection QR on mobile once connected or if scanning */
            .chat-area { height: 100%; }
            .files-panel { max-height: 150px; } /* Smaller file area on mobile */
            #local-video { width: 90px; height: 120px; bottom: 90px; }
            /* Toggle view logic via JS for mobile sidebar/chat */
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="header">
                <h2>QR Send</h2>
                <span id="status-badge" class="status-badge">Disconnected</span>
            </div>
            
            <!-- Connection Panel -->
            <div class="connect-panel" id="connect-panel">
                <div id="qrcode"></div>
                <p id="connect-msg" style="color:#666; margin-bottom:10px;">Scan to connect devices</p>
                <div style="display:flex; justify-content:center; flex-wrap:wrap;">
                    <button class="btn btn-outline" onclick="shareQRCode()">ðŸ”— Share QR</button>
                    <button class="btn btn-primary" onclick="startScanner()">ðŸ“· Scan QR</button>
                </div>
            </div>

            <!-- File Transfer Panel -->
            <div class="files-panel">
                <div class="files-header">
                    <span>File Transfer</span>
                    <button class="btn-outline" style="padding:2px 8px; font-size:12px;" onclick="document.getElementById('file-input').click()">+ Add File</button>
                </div>
                <input type="file" id="file-input" multiple>
                <div id="transfer-list">
                    <!-- Transfers appear here -->
                </div>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="chat-area" id="chat-area" style="display:none;"> <!-- Hidden initially on mobile/until connect -->
            <div class="chat-header">
                <div class="chat-user">
                    <div class="avatar">ðŸ‘¤</div>
                    <div>
                        <div style="font-weight:bold;">Connected Peer</div>
                        <div style="font-size:11px; color:#666;">Online</div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="icon-btn" onclick="initCall(false)" title="Voice Call">ðŸ“ž</button>
                    <button class="icon-btn" onclick="initCall(true)" title="Video Call">ðŸ“¹</button>
                </div>
            </div>

            <div class="messages" id="messages">
                <!-- Messages here -->
            </div>

            <!-- Reply Preview -->
            <div class="reply-bar" id="reply-bar">
                <div>
                    <div style="color:var(--primary); font-weight:bold; font-size:10px;">Replying to...</div>
                    <div id="reply-text-preview"></div>
                </div>
                <button onclick="cancelReply()" style="border:none; background:none; font-size:16px;">âœ•</button>
            </div>

            <div class="input-area">
                <button class="icon-btn" onclick="document.getElementById('img-input').click()">ðŸ“Ž</button>
                <input type="file" id="img-input" accept="image/*" style="display:none">
                <input type="text" id="msg-input" placeholder="Type a message...">
                <button class="send-btn" onclick="sendText()">âž¤</button>
            </div>
        </div>
    </div>

    <!-- INCOMING CALL MODAL -->
    <div class="fullscreen-overlay" id="incoming-call-ui">
        <div class="call-card">
            <div class="call-avatar-lg"><img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" width="100%"></div>
            <h2 id="incoming-call-type">Incoming Video Call...</h2>
            <p style="color:#aaa; margin-top:10px;">Peer is calling you</p>
            <div class="call-actions">
                <button class="call-btn btn-reject" onclick="rejectCall()">ðŸ“ž</button>
                <button class="call-btn btn-accept" onclick="answerCall()">ðŸ“ž</button>
            </div>
        </div>
    </div>

    <!-- ACTIVE CALL UI -->
    <div class="fullscreen-overlay" id="active-call-ui">
        <div class="active-call-ui">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-controls-bar">
                <button class="control-btn" id="btn-mute" onclick="toggleMic()">ðŸŽ¤</button>
                <button class="control-btn btn-hangup" onclick="endCall()">ðŸ“ž</button>
                <button class="control-btn" id="btn-cam" onclick="toggleCam()">ðŸ“·</button>
            </div>
        </div>
    </div>

    <!-- IMAGE PREVIEW MODAL -->
    <div class="modal" id="img-modal">
        <div class="modal-close" onclick="closeModal()">âœ•</div>
        <img id="modal-img" src="">
        <a id="modal-dl" href="#" class="modal-dl" download>Download</a>
    </div>

    <!-- SCANNER OVERLAY -->
    <div id="scanner-overlay">
        <div class="scanner-close" onclick="stopScanner()">âœ•</div>
        <div id="qr-reader"></div>
    </div>

    <script>
        // --- CORE STATE ---
        let peer, conn, myId, isHost;
        let activeCall = null, localStream = null;
        let replyContext = null;
        let fileQueue = [], activeTransfer = null, isTransferring = false;
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Listener for reload
            window.addEventListener('beforeunload', (e) => {
                // Instant Reset Logic: If refreshing, strip hash to force Host mode next time
                if (window.location.hash) {
                    history.replaceState(null, null, ' ');
                }
                if(conn || isTransferring) {
                    e.preventDefault(); e.returnValue = '';
                }
            });

            initApp();
        });

        function initApp() {
            const hash = window.location.hash.substring(1);
            isHost = !hash;
            
            peer = new Peer({ config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });

            peer.on('open', (id) => {
                myId = id;
                console.log('My ID:', id);
                
                if (isHost) {
                    // HOST MODE
                    new QRCode(document.getElementById('qrcode'), {
                        text: window.location.href + '#' + id,
                        width: 180, height: 180
                    });
                } else {
                    // CLIENT MODE - Auto Connect
                    document.getElementById('connect-panel').style.display = 'none';
                    document.getElementById('sidebar').style.display = 'none'; // On mobile show chat
                    document.getElementById('chat-area').style.display = 'flex';
                    connectToPeer(hash);
                }
            });

            peer.on('connection', (connection) => {
                setupConnection(connection);
            });

            peer.on('call', (call) => {
                // Incoming Call
                document.getElementById('incoming-call-ui').style.display = 'flex';
                document.getElementById('incoming-call-type').innerText = 
                    call.metadata && call.metadata.type === 'video' ? 'Incoming Video Call...' : 'Incoming Voice Call...';
                
                // Store temp reference to answer later
                window.pendingCall = call;
            });
            
            peer.on('error', (err) => {
                console.log(err);
                // Instant Reset on Error
                if(!isHost) {
                    window.location.hash = '';
                    window.location.reload();
                }
            });
        }

        function connectToPeer(id) {
            const connection = peer.connect(id);
            setupConnection(connection);
        }

        function setupConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                document.getElementById('status-badge').innerText = 'Connected';
                document.getElementById('status-badge').style.background = 'var(--green)';
                document.getElementById('connect-panel').style.display = 'none';
                document.getElementById('chat-area').style.display = 'flex';
                
                // For Host on Mobile, hide sidebar to show chat
                if(window.innerWidth < 768) {
                    document.getElementById('sidebar').style.display = 'none';
                }
            });

            conn.on('data', (data) => handleData(data));
            
            conn.on('close', () => {
                alert('Connection lost');
                window.location.hash = '';
                window.location.reload();
            });
        }

        // --- DATA HANDLER ---
        function handleData(data) {
            switch(data.type) {
                case 'text':
                    addMessage(data.content, 'received', data.reply);
                    conn.send({type: 'ack', id: data.id});
                    break;
                case 'image':
                    addImage(data.content, 'received', data.id);
                    conn.send({type: 'ack', id: data.id});
                    break;
                case 'ack':
                    markRead(data.id);
                    break;
                case 'dl-notify':
                    markDownloaded(data.id);
                    break;
                // File Transfer
                case 'file-meta':
                    startReceivingFile(data);
                    break;
                case 'file-chunk':
                    processFileChunk(data);
                    break;
                case 'file-cancel':
                    handleFileCancel(data.fileId);
                    break;
                // Call Signaling
                case 'call-end':
                    endCallUI();
                    break;
            }
        }

        // --- SHARE QR ---
        async function shareQRCode() {
            const canvas = document.querySelector('#qrcode canvas');
            const imgUrl = canvas.toDataURL();
            const blob = await (await fetch(imgUrl)).blob();
            const file = new File([blob], "qr_connect.png", { type: "image/png" });
            
            if (navigator.share) {
                navigator.share({
                    title: 'Connect on QR Send',
                    text: 'Scan this QR to chat and transfer files.',
                    files: [file],
                    url: window.location.href + '#' + myId
                });
            } else {
                alert('Sharing not supported on this browser.');
            }
        }

        // --- SCANNER ---
        let html5QrCode;
        function startScanner() {
            document.getElementById('scanner-overlay').style.display = 'flex';
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 30, qrbox: { width: 250, height: 250 } }, // Fast FPS
                (decodedText) => {
                    stopScanner();
                    const peerId = decodedText.split('#')[1];
                    if(peerId) {
                        window.location.hash = peerId;
                        window.location.reload();
                    }
                }
            );
        }
        function stopScanner() {
            if(html5QrCode) { 
                html5QrCode.stop().then(() => {
                    html5QrCode.clear(); 
                    document.getElementById('scanner-overlay').style.display = 'none';
                }); 
            }
        }

        // --- CHAT LOGIC ---
        function sendText() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !conn) return;
            
            const msgId = Date.now();
            conn.send({ type: 'text', content: text, id: msgId, reply: replyContext });
            addMessage(text, 'sent', replyContext, msgId);
            input.value = '';
            cancelReply();
        }

        function addMessage(text, type, reply, id) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.id = `msg-${id}`;
            
            let content = '';
            if(reply) {
                content += `<div class="msg-reply-preview">${reply.text.substring(0,50)}...</div>`;
            }
            content += `
                ${text}
                <div class="msg-time">
                    ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    ${type === 'sent' ? '<span class="double-tick">âœ“</span>' : ''}
                </div>
                <div class="reply-btn" onclick="setReply('${text.replace(/'/g, "\\'")}')">â†©</div>
            `;
            div.innerHTML = content;
            document.getElementById('messages').appendChild(div);
            scrollToBottom();
        }

        function markRead(id) {
            const el = document.querySelector(`#msg-${id} .double-tick`);
            if(el) el.innerText = 'âœ“âœ“';
        }

        // --- IMAGE LOGIC ---
        document.getElementById('img-input').onchange = function() {
            const file = this.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const msgId = Date.now();
                const base64 = e.target.result;
                conn.send({ type: 'image', content: base64, id: msgId });
                addImage(base64, 'sent', msgId);
            };
            reader.readAsDataURL(file);
        };

        function addImage(src, type, id) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.id = `msg-${id}`;
            div.innerHTML = `
                <img src="${src}" onclick="openModal(this.src, '${type}', ${id})">
                <div class="msg-time">
                    ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    ${type === 'sent' ? '<span class="double-tick">âœ“</span>' : ''}
                </div>
                ${type === 'sent' ? '<div class="download-indicator" style="font-size:10px; display:none;">Downloaded by peer</div>' : ''}
            `;
            document.getElementById('messages').appendChild(div);
            scrollToBottom();
        }

        function openModal(src, type, id) {
            document.getElementById('img-modal').style.display = 'flex';
            document.getElementById('modal-img').src = src;
            const dlBtn = document.getElementById('modal-dl');
            
            if(type === 'received') {
                dlBtn.style.display = 'block';
                dlBtn.href = src;
                dlBtn.onclick = () => {
                    conn.send({type: 'dl-notify', id: id});
                }
            } else {
                dlBtn.style.display = 'none';
            }
        }
        function closeModal() { document.getElementById('img-modal').style.display = 'none'; }
        function markDownloaded(id) {
            const el = document.querySelector(`#msg-${id} .download-indicator`);
            if(el) el.style.display = 'block';
        }

        function scrollToBottom() {
            const el = document.getElementById('messages');
            el.scrollTop = el.scrollHeight;
        }

        // --- REPLY SYSTEM ---
        function setReply(text) {
            replyContext = { text: text };
            document.getElementById('reply-bar').style.display = 'flex';
            document.getElementById('reply-text-preview').innerText = text.substring(0, 50) + '...';
            document.getElementById('msg-input').focus();
        }
        function cancelReply() {
            replyContext = null;
            document.getElementById('reply-bar').style.display = 'none';
        }

        // --- FILE TRANSFER LOGIC (Optimized & Scrollable) ---
        document.getElementById('file-input').onchange = function() {
            for(let file of this.files) {
                const fileId = Date.now() + Math.random().toString(36).substr(2, 9);
                fileQueue.push({ file, id: fileId });
                createFileUI(fileId, file.name, 'Sending');
            }
            processFileQueue();
            this.value = '';
        };

        function createFileUI(id, name, type) {
            const div = document.createElement('div');
            div.className = 'transfer-item';
            div.id = `file-${id}`;
            div.innerHTML = `
                <div class="t-info">
                    <span class="t-name">${name}</span>
                    <button class="btn-cancel" onclick="cancelTransfer('${id}', '${type}')">âœ•</button>
                </div>
                <div class="t-bar-bg"><div class="t-bar-fill" id="bar-${id}"></div></div>
                <div class="t-meta">
                    <span id="prog-${id}">0%</span>
                    <span id="eta-${id}">Calculating...</span>
                </div>
            `;
            document.getElementById('transfer-list').prepend(div); // Add new to top
        }

        function processFileQueue() {
            if(isTransferring || fileQueue.length === 0) return;
            const item = fileQueue.shift();
            activeTransfer = item;
            isTransferring = true;
            
            conn.send({ type: 'file-meta', fileId: item.id, name: item.file.name, size: item.file.size });
            
            const chunkSize = 16384; // 16KB safe chunk
            const reader = new FileReader();
            let offset = 0;
            let startTime = Date.now();

            reader.onload = function(e) {
                if(!activeTransfer) return; // Cancelled
                
                conn.send({
                    type: 'file-chunk',
                    fileId: item.id,
                    data: e.target.result
                });
                
                offset += e.target.result.byteLength;
                updateProgress(item.id, offset, item.file.size, startTime);

                if(offset < item.file.size) {
                    readNext();
                } else {
                    isTransferring = false;
                    setTimeout(processFileQueue, 100);
                }
            };

            const readNext = () => {
                const slice = item.file.slice(offset, offset + chunkSize);
                reader.readAsArrayBuffer(slice);
            };
            readNext();
        }

        // Receiver State
        let receiving = {}; 

        function startReceivingFile(meta) {
            receiving[meta.fileId] = {
                name: meta.name,
                size: meta.size,
                received: 0,
                buffer: [],
                startTime: Date.now()
            };
            createFileUI(meta.fileId, meta.name, 'Receiving');
        }

        function processFileChunk(data) {
            const fileObj = receiving[data.fileId];
            if(!fileObj) return; // Cancelled or done

            fileObj.buffer.push(data.data);
            fileObj.received += data.data.byteLength;
            
            updateProgress(data.fileId, fileObj.received, fileObj.size, fileObj.startTime);

            if(fileObj.received >= fileObj.size) {
                const blob = new Blob(fileObj.buffer);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = fileObj.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                delete receiving[data.fileId];
                document.getElementById(`eta-${data.fileId}`).innerText = 'Completed';
            }
        }

        function updateProgress(id, current, total, startTime) {
            const percent = Math.round((current / total) * 100);
            const bar = document.getElementById(`bar-${id}`);
            const text = document.getElementById(`prog-${id}`);
            const etaEl = document.getElementById(`eta-${id}`);

            if(bar) bar.style.width = percent + '%';
            if(text) text.innerText = percent + '%';
            
            // ETA Calc
            const elapsed = (Date.now() - startTime) / 1000; // seconds
            const speed = current / elapsed; // bytes per sec
            const remaining = total - current;
            const secondsLeft = remaining / speed;
            
            if(etaEl && isFinite(secondsLeft)) {
                etaEl.innerText = secondsLeft < 1 ? 'Almost done' : Math.ceil(secondsLeft) + 's left';
            }
        }

        function cancelTransfer(id, type) {
            // UI Update
            const el = document.getElementById(`file-${id}`);
            if(el) el.remove();
            
            conn.send({type: 'file-cancel', fileId: id});

            if(type === 'Sending') {
                if(activeTransfer && activeTransfer.id === id) {
                    activeTransfer = null;
                    isTransferring = false;
                    processFileQueue();
                } else {
                    fileQueue = fileQueue.filter(i => i.id !== id);
                }
            } else {
                delete receiving[id];
            }
        }

        function handleFileCancel(id) {
             const el = document.getElementById(`file-${id}`);
             if(el) el.innerHTML = '<span style="color:red">Cancelled by peer</span>';
             if(activeTransfer && activeTransfer.id === id) {
                 activeTransfer = null; isTransferring = false; processFileQueue();
             }
             delete receiving[id];
        }


        // --- CALL LOGIC (WhatsApp Style) ---
        function initCall(isVideo) {
            if(!conn) return;
            navigator.mediaDevices.getUserMedia({video: isVideo, audio: true})
            .then(stream => {
                startLocalStream(stream, isVideo);
                const call = peer.call(conn.peer, stream, { metadata: { type: isVideo ? 'video' : 'audio' } });
                handleCallEvents(call);
            })
            .catch(e => alert('Camera/Mic permission needed'));
        }

        function answerCall() {
            document.getElementById('incoming-call-ui').style.display = 'none';
            const call = window.pendingCall;
            const isVideo = call.metadata.type === 'video';
            
            navigator.mediaDevices.getUserMedia({video: isVideo, audio: true})
            .then(stream => {
                startLocalStream(stream, isVideo);
                call.answer(stream);
                handleCallEvents(call);
            });
        }

        function rejectCall() {
            document.getElementById('incoming-call-ui').style.display = 'none';
            // Simple rejection by closing connection
            if(window.pendingCall) window.pendingCall.close();
            conn.send({type: 'call-end'});
        }

        function startLocalStream(stream, isVideo) {
            localStream = stream;
            document.getElementById('active-call-ui').style.display = 'flex';
            document.getElementById('local-video').srcObject = stream;
            // If audio only, maybe show avatar? For now simplified
        }

        function handleCallEvents(call) {
            activeCall = call;
            call.on('stream', (remoteStream) => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });
            call.on('close', () => endCallUI());
            call.on('error', () => endCallUI());
        }

        function endCall() {
            if(activeCall) activeCall.close();
            endCallUI();
            conn.send({type: 'call-end'});
        }

        function endCallUI() {
            document.getElementById('active-call-ui').style.display = 'none';
            document.getElementById('incoming-call-ui').style.display = 'none';
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            activeCall = null;
        }

        // In-Call Controls
        function toggleMic() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('btn-mute').classList.toggle('off');
        }
        function toggleCam() {
            const track = localStream.getVideoTracks()[0];
            if(track) {
                track.enabled = !track.enabled;
                document.getElementById('btn-cam').classList.toggle('off');
            }
        }

    </script>
</body>
</html>
